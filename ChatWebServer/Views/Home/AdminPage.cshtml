@model List<ChatWebServer.Models.User>

@{
    ViewData["Title"] = "Admin Page";
}

<div class="text-center">
    <button type="button" class="btn" id="openAdminModalBtn">Do Admin Stuff</button>
    <div class="chat-container" id="msgs">
        <!-- Messages will be dynamically added here -->
    </div>

    <div id="inputBox">
        <input type="text" id="messageField" placeholder="Type a message and press Enter" />
    </div>
    <!-- Dialog for CRUD operations on User table-->
    <dialog id="manageUsersDialog">
        <div id="userList">
            @foreach (var user in Model)
            {
                <div class="user-box" onclick="expandUser(this)">
                    <p>@user.Username</p>
                    <div class="user-info" style="display: none;">
                        <p data-info="userId">ID: @user.UserID</p>
                        <p>Role: @user.Role</p>
                        <p>Active: @user.IsActive</p>
                    </div>
                </div>
            }
        </div>
        <form method="dialog" id="userForm">
            <div id="userFormContainer">
                <!-- User form will be loaded here -->
            </div>
            <button type="button" id="addUserBtn" class="btn btn-primary">Add User</button>
            <button type="button" id="updateUserBtn" class="btn btn-primary">Update User</button>
            <button type="button" id="closeDialogBtn" class="btn btn-secondary">Close</button>
        </form>
    </dialog>
</div>

<!-- Store the authenticated username in a JavaScript variable -->
<script>
    var userName = @Json.Serialize(Context.User.Identity.Name);

    const showButton = document.getElementById("openAdminModalBtn");
    const favDialog = document.getElementById("manageUsersDialog");

    showButton.addEventListener("click", () => {
        favDialog.showModal();
    });

    function expandUser(userBox) {
        const userInfo = userBox.querySelector(".user-info");
        userInfo.style.display = userInfo.style.display === "none" ? "block" : "none";
    }
</script>

<script>

    const userFormContainer = document.getElementById("userFormContainer");

    loadUserList();

    function loadUserList() {
        fetch("/Home/AdminPage")
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const html = parser.parseFromString(data, "text/html");
                const userListContainer = document.getElementById("userList");
                userListContainer.innerHTML = html.getElementById("userList").innerHTML;
            });
    }

    function loadUserForm(userId = 0) {
        fetch(`/Home/GetUser?userId=${userId}`)
            .then(response => response.text())
            .then(data => {
                userFormContainer.innerHTML = data;
            });
    }

    document.getElementById("addUserBtn").addEventListener("click", () => {
        loadUserForm();
    });

    document.getElementById("updateUserBtn").addEventListener("click", () => {
        const selectedUserBox = document.querySelector(".user-box.selected");
        if (!selectedUserBox) {
            alert("Please select a user to update.");
            return;
        }

        const userId = selectedUserBox.querySelector("p[data-info='userId']").innerText.split(":")[1].trim();
        loadUserForm(userId);
    });

    document.getElementById("closeDialogBtn").addEventListener("click", () => {
        const dialog = document.getElementById("manageUsersDialog");
        dialog.close();

        userFormContainer.innerHTML = "";
    });

</script>

<!-- User form template -->
<script type="text/template" id="userFormTemplate">
    <div class="form-group">
        <label for="username">Username</label>
        <input type="text" class="form-control" id="username" name="Username" required />
    </div>
    <div class="form-group">
        <label for="password">Password</label>
        <input type="password" class="form-control" id="password" name="Password" required />
    </div>
    <div class="form-group">
        <label for="role">Role</label>
        <select class="form-control" id="role" name="Role">
            <option value="ADMIN">ADMIN</option>
            <option value="USER">USER</option>
        </select>
    </div>
    <div class="form-group form-check">
        <input type="checkbox" class="form-check-input" id="isActive" name="IsActive" />
        <label class="form-check-label" for="isActive">Active</label>
    </div>
</script>
